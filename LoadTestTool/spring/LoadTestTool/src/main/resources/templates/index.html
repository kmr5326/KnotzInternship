<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoadTestTool</title>
</head>
<body>
<h1>Load test tool</h1>

<form id="loadTestForm" action="/submit" method="POST">
    <div>
        <label for="threads">Number of Threads:</label>
        <input type="number" id="threads" name="threads" min="1" required>
    </div>

    <div>
        <label for="rampUp">Ramp-up period (seconds):</label>
        <input type="number" id="rampUp" name="rampUp" min="1" required>
    </div>

    <div>
        <label for="loopCount">Loop Count:</label>
        <input type="number" id="loopCount" name="loopCount" min="1" required>
    </div>

    <div>
        <label for="duration">Duration (seconds):</label>
        <input type="number" id="duration" name="duration" min="1" required>
    </div>

    <label for="APIs">Select an API:</label>
    <select id="APIs" name="APIs" onchange="updateFields()">
        <option value="">Select an API</option>
        <option th:each="api : ${APIs}" th:value="${api}" th:text="${api}"></option>
    </select>

    <div id="parameters">
        <!-- 여기에 동적으로 입력 필드가 추가됨 -->
    </div>

    <div id="apiList"></div>

    <button type="button" onclick="addApiToList()">추가</button>
    <button type="submit" onclick="submitForm()">Submit</button>
</form>

<h1>InfluxDB Data Write Test</h1>
<form action="/influxDB/write-to-influxdb" method="get">
    <button type="submit">Write to InfluxDB</button>
</form>

<input type="hidden" id="apiParameters" th:value='${apiParameters}' />

<script >
    // 페이지가 로드된 후 updateFields 함수가 실행되도록
    document.addEventListener("DOMContentLoaded", function() {
        // 처음에 API가 선택되지 않았으므로 빈 상태로 두고, 드롭다운 변화가 있을 때마다 updateFields()가 실행됨
        updateFields();
    });

    // API에 따라 입력 필드를 동적으로 변경하는 함수
    function updateFields() {
        // 선택된 API
        var selectedApi = document.getElementById("APIs").value;
        // console.log("selected: "+selectedApi);

        //파라미터 필드 div
        var paramsDiv = document.getElementById("parameters");
        paramsDiv.innerHTML = "";  // 기존 입력 필드를 지움

        // 파라미터 목록을 가져옴
        var apiParameters=JSON.parse(document.getElementById("apiParameters").value);
        // console.log(apiParameters[selectedApi]);
        var params = apiParameters[selectedApi];

        // 각 파라미터에 대해 입력 필드 생성
        if (params) {
            params.forEach(function(param) {
                var label = document.createElement("label");
                label.setAttribute("for", param);
                label.textContent = param.charAt(0).toUpperCase() + param.slice(1) + ":";

                var input = document.createElement("input");
                input.setAttribute("type", "text");
                input.setAttribute("id", param);
                input.setAttribute("name", param);
                // input.setAttribute("placeholder", "Enter " + param);

                paramsDiv.appendChild(label);
                paramsDiv.appendChild(input);
                paramsDiv.appendChild(document.createElement("br"));
            });
        }
    }

    // "추가" 버튼 클릭 시 선택된 API와 입력된 파라미터를 리스트에 추가하는 함수
    function addApiToList() {
        var selectedApi = document.getElementById("APIs").value;
        if (!selectedApi) return;

        var paramsDiv = document.getElementById("parameters");
        var apiListDiv = document.getElementById("apiList");

        // 해당 API와 입력된 파라미터들 가져오기
        var apiParameters = JSON.parse(document.getElementById("apiParameters").value);
        var params = apiParameters[selectedApi];

        var apiDataDiv = document.createElement("div");
        apiDataDiv.setAttribute("class", "api-data");

        var apiLabel = document.createElement("p");
        apiLabel.textContent = "API: " + selectedApi;
        apiDataDiv.appendChild(apiLabel);

        // API와 관련된 입력 필드를 array로 만들어서 전송
        var paramValues = {};
        params.forEach(function(param) {
            var paramInput = document.getElementById(param);
            if (paramInput) {
                var paramData = document.createElement("p");
                paramData.textContent = param + ": " + paramInput.value;
                apiDataDiv.appendChild(paramData);

                // paramValues에 해당 파라미터 값을 담음
                paramValues[param] = paramInput.value;
            }
        });

        // API와 파라미터들을 리스트에 담기
        var hiddenInput = document.createElement("input");
        hiddenInput.setAttribute("type", "hidden");
        hiddenInput.setAttribute("name", "apiList");  // apiList라는 이름으로 전송
        hiddenInput.setAttribute("value", JSON.stringify({api: selectedApi, params: paramValues}));

        apiListDiv.appendChild(hiddenInput);

        // 리스트에 추가된 항목 표시
        apiListDiv.appendChild(apiDataDiv);
    }

    function submitForm() {
        var form = document.getElementById("loadTestForm");

        var apiListInputs = document.getElementsByName("apiList");

        if (apiListInputs.length === 1) {
            var apiListDiv = document.getElementById("apiList");
            var hiddenInput = document.createElement("input");
            hiddenInput.setAttribute("type", "hidden");
            hiddenInput.setAttribute("name", "apiList");
            hiddenInput.setAttribute("value", JSON.stringify({api: "null"}));

            apiListDiv.appendChild(hiddenInput);
        }

        form.submit();  // 폼을 실제로 제출
    }
</script>
</body>
<style>
    /* userCount와 requestCount 필드 크기 줄이기 */
    #userCount, #requestCount {
        width: 50px;  /* 가로 크기 */
        padding: 5px;  /* 안쪽 여백 */
        font-size: 14px; /* 글씨 크기 */
    }
</style>
</html>