<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoadTestTool</title>
    <style>
        .api-request {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        .remove-api {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
<h1>Load Test Tool</h1>

<form id="loadTestForm" action="/submit" method="POST">
    <!-- 로그인 요청 섹션 -->
    <fieldset>
        <legend>로그인 요청</legend>
        <div>
            <label for="loginUsername">Username:</label>
            <input type="text" id="loginUsername" name="loginRequest.username" required>
        </div>
        <div>
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" name="loginRequest.password" required>
        </div>
    </fieldset>

    <hr>

    <!-- API 요청 리스트 섹션 -->
    <fieldset>
        <legend>API 요청 리스트</legend>
        <div id="apiRequestsContainer">
            <!-- 동적으로 API 요청이 추가됨 -->
        </div>
        <button type="button" onclick="addApiRequest()">API 요청 추가</button>
    </fieldset>

    <hr>

    <!-- 부하 테스트 설정 섹션 -->
    <fieldset>
        <legend>부하 테스트 설정</legend>
        <div>
            <label for="threads">스레드 수:</label>
            <input type="number" id="threads" name="numberOfThreads" min="1" required>
        </div>
        <div>
            <label for="rampUp">램프업 기간 (초):</label>
            <input type="number" id="rampUp" name="rampUpPeriodSeconds" min="0" required>
        </div>
        <div>
            <label for="loopCount">반복 횟수:</label>
            <input type="number" id="loopCount" name="loopCount" min="1" required>
        </div>
        <div>
            <label for="duration">테스트 지속 시간 (초):</label>
            <input type="number" id="duration" name="durationSeconds" min="1" required>
        </div>
    </fieldset>

    <hr>

    <button type="submit">Submit</button>
</form>

<input type="hidden" id="apiParameters" th:value='${apiParameters}' />

<script>
    // 초기 API 요청 카운트 변수 제거

    // API 요청 추가 함수
    function addApiRequest() {
        const container = document.getElementById('apiRequestsContainer');
        const currentCount = container.querySelectorAll('.api-request').length; // 현재 API 요청 수를 기준으로 인덱스 설정
        const apiDiv = document.createElement('div');
        apiDiv.className = 'api-request';
        apiDiv.id = `apiRequest-${currentCount}`;

        apiDiv.innerHTML = `
            <button type="button" class="remove-api" onclick="removeApiRequest(${currentCount})">삭제</button>
            <h3>API 요청 ${currentCount + 1}</h3>
            <div>
                <label for="apiRequests[${currentCount}].name">API 이름:</label>
                <input type="text" id="apiRequests[${currentCount}].name" name="apiRequests[${currentCount}].name" required>
            </div>
            <div>
                <label for="apiRequests[${currentCount}].url">API URL:</label>
                <input type="url" id="apiRequests[${currentCount}].url" name="apiRequests[${currentCount}].url" required>
            </div>
            <div>
                <label for="apiRequests[${currentCount}].method">HTTP Method:</label>
                <select id="apiRequests[${currentCount}].method" name="apiRequests[${currentCount}].method" required>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
            </div>
            <div>
                <label for="apiRequests[${currentCount}].pathVariables">Path Variables (JSON 형식):</label>
                <textarea id="apiRequests[${currentCount}].pathVariables" name="apiRequests[${currentCount}].pathVariables" placeholder='e.g., {"id": "123"}'></textarea>
            </div>
            <div>
                <label for="apiRequests[${currentCount}].queryParameters">Query Parameters (JSON 형식):</label>
                <textarea id="apiRequests[${currentCount}].queryParameters" name="apiRequests[${currentCount}].queryParameters" placeholder='e.g., {"name": "john", "age": "30"}'></textarea>
            </div>
            <div>
                <label for="apiRequests[${currentCount}].headers">Headers (JSON 형식):</label>
                <textarea id="apiRequests[${currentCount}].headers" name="apiRequests[${currentCount}].headers" placeholder='e.g., {"Authorization": "Bearer token"}'></textarea>
            </div>
            <div>
                <label for="apiRequests[${currentCount}].body">Body:</label>
                <textarea id="apiRequests[${currentCount}].body" name="apiRequests[${currentCount}].body" placeholder='Enter request body here...'></textarea>
            </div>
            <div>
                <label for="apiRequests[${currentCount}].contentType">Content Type:</label>
                <input type="text" id="apiRequests[${currentCount}].contentType" name="apiRequests[${currentCount}].contentType" placeholder='e.g., application/json'>
            </div>
            <hr>
        `;

        container.appendChild(apiDiv);
    }

    // API 요청 삭제 함수
    function removeApiRequest(id) {
        const apiDiv = document.getElementById(`apiRequest-${id}`);
        if (apiDiv) {
            apiDiv.remove();

            const apiRequests = document.querySelectorAll('.api-request');
            apiRequests.forEach((apiRequestDiv, index) => {
                apiRequestDiv.id = `apiRequest-${index}`;
                apiRequestDiv.querySelector('h3').textContent = `API 요청 ${index + 1}`;

                const inputs = apiRequestDiv.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    const nameAttr = input.getAttribute('name');
                    const idAttr = input.getAttribute('id');

                    // 정규 표현식을 사용하여 현재 인덱스만 대체
                    const newName = nameAttr.replace(/\d+/, index);
                    const newId = idAttr.replace(/\d+/, index);

                    input.setAttribute('name', newName);
                    input.setAttribute('id', newId);
                });

                const removeButton = apiRequestDiv.querySelector('.remove-api');
                removeButton.setAttribute('onclick', `removeApiRequest(${index})`);
            });
        }
    }

    // JSON 유효성 검사 함수
    function validateJsonInput(jsonString) {
        if (!jsonString.trim()) return true; // 빈 입력은 허용
        try {
            JSON.parse(jsonString);
            return true;
        } catch (e) {
            return false;
        }
    }

    // 폼 제출 전 데이터 검증
    function submitForm(event) {
        const apiRequests = document.querySelectorAll('.api-request');
        if (apiRequests.length === 0) {
            alert('적어도 하나의 API 요청을 추가해야 합니다.');
            event.preventDefault();
            return;
        }

        let isValid = true;
        apiRequests.forEach((apiRequestDiv, index) => {
            const name = apiRequestDiv.querySelector(`[name="apiRequests[${index}].name"]`).value.trim();
            const url = apiRequestDiv.querySelector(`[name="apiRequests[${index}].url"]`).value.trim();
            const method = apiRequestDiv.querySelector(`[name="apiRequests[${index}].method"]`).value.trim();
            const pathVariables = apiRequestDiv.querySelector(`[name="apiRequests[${index}].pathVariables"]`).value;
            const queryParameters = apiRequestDiv.querySelector(`[name="apiRequests[${index}].queryParameters"]`).value;
            const headers = apiRequestDiv.querySelector(`[name="apiRequests[${index}].headers"]`).value;

            // 필수 필드 검사
            if (!name || !url || !method) {
                alert(`API 요청 ${index + 1}의 필수 필드가 비어 있습니다.`);
                isValid = false;
                return;
            }

            // JSON 필드 유효성 검사
            if (!validateJsonInput(pathVariables)) {
                alert(`API 요청 ${index + 1}의 Path Variables가 유효한 JSON 형식이 아닙니다.`);
                isValid = false;
                return;
            }

            if (!validateJsonInput(queryParameters)) {
                alert(`API 요청 ${index + 1}의 Query Parameters가 유효한 JSON 형식이 아닙니다.`);
                isValid = false;
                return;
            }

            if (!validateJsonInput(headers)) {
                alert(`API 요청 ${index + 1}의 Headers가 유효한 JSON 형식이 아닙니다.`);
                isValid = false;
                return;
            }
        });

        if (!isValid) {
            event.preventDefault();
        }
    }

    // 폼 제출 이벤트 리스너 추가
    document.getElementById('loadTestForm').addEventListener('submit', submitForm);

    // 페이지가 로드된 후 기본 API 요청 추가 (제거)
    // document.addEventListener("DOMContentLoaded", function () {
    //     addApiRequest(); // 기본 API 요청 추가
    // });
</script>
</body>
</html>
